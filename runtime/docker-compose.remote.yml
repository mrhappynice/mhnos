# MHNOS Runtime - Remote VPS Deployment with MinIO S3
# Usage: docker-compose -f docker-compose.remote.yml up -d
#
# This stack includes:
# - MinIO S3-compatible object storage for files
# - MHNOS Runtime bridge (WebSocket + S3 integration)
# - Optional: Nginx reverse proxy for SSL

version: '3.8'

services:
  # ============================================================================
  # MinIO S3 Object Storage
  # ============================================================================
  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: mhnos-minio
    hostname: minio
    command: server /data --console-address ":9001"
    restart: unless-stopped
    
    volumes:
      - minio-data:/data
    
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-mhnosadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change-me-in-production}
      MINIO_BROWSER_REDIRECT_URL: ${MINIO_BROWSER_REDIRECT_URL:-}
      # Enable public read for workspace bucket (controlled by runtime)
      MINIO_POLICY: "none"
    
    networks:
      - mhnos-network
    
    # MinIO API on 9000, Console on 9001
    ports:
      - "9000:9000"
      - "9001:9001"
    
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # MinIO Client - Bucket Setup
  # ============================================================================
  minio-setup:
    image: minio/mc:RELEASE.2025-01-17T23-25-50Z
    container_name: mhnos-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Setting up MinIO...';
      mc alias set local http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      
      # Create workspace bucket if not exists
      mc mb local/workspace --ignore-existing;
      
      # Set bucket policy - allow runtime service full access
      mc policy set public local/workspace || true;
      
      # Create lifecycle rule to clean up old temp files (7 days)
      mc ilm rule add local/workspace --expire-days 7 --prefix 'temp/' || true;
      
      echo 'MinIO setup complete';
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-mhnosadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-change-me-in-production}
    networks:
      - mhnos-network
    restart: "no"

  # ============================================================================
  # MHNOS Runtime Bridge
  # ============================================================================
  runtime:
    build:
      context: .
      dockerfile: Dockerfile.remote
      args:
        INSTALL_OPENCLAW: "${INSTALL_OPENCLAW:-true}"
    container_name: mhnos-runtime
    hostname: mhnos-runtime
    restart: unless-stopped
    
    depends_on:
      minio:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    
    networks:
      - mhnos-network
    
    # WebSocket port for MHNOS browser connection
    ports:
      - "${MHNOS_RUNTIME_PORT:-18790}:18790"
    
    environment:
      # Runtime Configuration
      - MHNOS_RUNTIME_PORT=18790
      - MHNOS_WORKSPACE=/workspace
      - MHNOS_SANDBOX=${MHNOS_SANDBOX:-relaxed}
      - MHNOS_ALLOW_OPENCLAW=${MHNOS_ALLOW_OPENCLAW:-true}
      - MHNOS_LOG_LEVEL=${MHNOS_LOG_LEVEL:-info}
      - MHNOS_MAX_PROCESSES=${MHNOS_MAX_PROCESSES:-50}
      - MHNOS_MAX_MEMORY=${MHNOS_MAX_MEMORY:-2g}
      
      # S3/MinIO Configuration
      - S3_ENDPOINT=http://minio:9000
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT:-}
      - S3_BUCKET=workspace
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-mhnosadmin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-change-me-in-production}
      - S3_REGION=us-east-1
      - S3_FORCE_PATH_STYLE=true
      
      # Presigned URL expiration (seconds)
      - S3_PRESIGN_EXPIRY=3600
      
      # Workspace sync configuration
      - SYNC_ON_CONNECT=${SYNC_ON_CONNECT:-false}
      - SYNC_EXCLUDE_PATTERNS=${SYNC_EXCLUDE_PATTERNS:-node_modules,.git,dist,.cache,*.tmp}
    
    volumes:
      # Runtime state (not file storage - files go to S3)
      - runtime-state:/opt/mhnos-runtime/state
      # Temporary workspace (synced from S3 on demand)
      - runtime-workspace:/workspace
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '${RUNTIME_CPU_LIMIT:-2.0}'
          memory: ${RUNTIME_MEMORY_LIMIT:-3G}
        reservations:
          cpus: '${RUNTIME_CPU_RESERVE:-1.0}'
          memory: ${RUNTIME_MEMORY_RESERVE:-2G}
    
    # Security (relaxed for OpenClaw - AI needs full access)
    security_opt:
      - no-new-privileges:false
    read_only: false
    cap_drop: []
    
    # Required for s3fs (FUSE filesystem)
    privileged: true
    devices:
      - /dev/fuse:/dev/fuse
    
    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18790/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Nginx Reverse Proxy (Optional - for SSL)
  # ============================================================================
  # Uncomment this section and configure certs for HTTPS
  # nginx:
  #   image: nginx:alpine
  #   container_name: mhnos-nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   networks:
  #     - mhnos-network
  #   depends_on:
  #     - runtime
  #     - minio

# ==============================================================================
# Networks
# ==============================================================================
networks:
  mhnos-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  minio-data:
    driver: local
  runtime-state:
    driver: local
  runtime-workspace:
    driver: local
