# MHNOS Workerd Runtime - Docker Compose
# Usage: docker-compose up -d

version: '3.8'

services:
  # Main runtime service
  mhnos-runtime:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Set to 'true' to include OpenClaw in the image
        INSTALL_OPENCLAW: "false"
    container_name: mhnos-runtime
    hostname: mhnos-runtime
    
    # Resource limits for isolation
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    
    # Network configuration
    networks:
      - mhnos-network
    
    # Port mapping for WebSocket communication
    ports:
      - "127.0.0.1:18790:18790"
    
    # Volume mounts
    volumes:
      # Persistent workspace for files
      - mhnos-workspace:/workspace
      # Optional: Mount local workspace for development
      - ./dev-workspace:/dev-workspace
    
    # Environment variables
    environment:
      - MHNOS_RUNTIME_PORT=18790
      - MHNOS_WORKSPACE=/workspace
      - MHNOS_SANDBOX=strict
      - MHNOS_ALLOW_OPENCLAW=false
      - MHNOS_LOG_LEVEL=info
    
    # Security options
    security_opt:
      - no-new-privileges:false
    
    # Read-only root filesystem for security
    read_only: false
    
    # Tmpfs mounts for writable directories
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=50m
    
    # Capabilities to drop (restrict privileges)
    cap_drop:
      - ALL
    
    # Capabilities to add (minimal required)
    cap_add:
      - SETUID
      - SETGID
    
    # Restart policy
    restart: unless-stopped
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: OpenClaw-enabled runtime (separate service)
  mhnos-runtime-openclaw:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_OPENCLAW: "true"
    container_name: mhnos-runtime-openclaw
    hostname: mhnos-runtime-openclaw
    
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 2G
    
    networks:
      - mhnos-network
    
    ports:
      - "127.0.0.1:18791:18790"
    
    volumes:
      - mhnos-workspace-openclaw:/workspace
      - ./dev-workspace:/dev-workspace
    
    environment:
      - MHNOS_RUNTIME_PORT=18790
      - MHNOS_WORKSPACE=/workspace
      - MHNOS_SANDBOX=strict
      - MHNOS_ALLOW_OPENCLAW=true
      - OPENCLAW_WORKSPACE=/workspace
      - OPENCLAW_SANDBOX=strict
      - MHNOS_LOG_LEVEL=info
    
    user: root
    
    # No restrictions - full container access for AI agent
    read_only: false
    
    security_opt:
      - no-new-privileges:false
    
    # Allow all capabilities
    cap_drop: []
    
    restart: unless-stopped
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    
    # Don't start by default
    profiles:
      - openclaw

# Networks (using default bridge to avoid conflicts)
networks:
  mhnos-network:
    driver: bridge

# Volumes
volumes:
  mhnos-workspace:
    driver: local
  mhnos-workspace-openclaw:
    driver: local
